<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="layout/popup2">

	<head>
	    <title>[[#{screen.text.inv.mng.upload.screen.title}]]</title>
	</head>
        
	<!-- css -->
	<th:block layout:fragment="css">	
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/theme.css" />
		<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.8/css/tabulator.min.css" rel="stylesheet"> 
	</th:block>  

	 <th:block layout:fragment="script">
		<script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
		<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.0.7/dist/js/tabulator.min.js"></script>
	
		<script>

    		let batchGrid;		
		    let excelUpData = new FormData();
		    let remainQty = "[[${remainQty}]]";
		    
			$(function(){
				
				batchGrid = new Tabulator("#batch-table", {
				 	locale:true,
				    langs: $.commGridLocalization(),								
				 	height:"550",
				 	layout:"fitDataStretch",
				 	movableColumns:true,
				 	placeholder:"No Data Set",	
				 	index:"asetNo",				 	
				 	columns:[
				 		{formatter:"rownum", hozAlign:"center", width:40, headerSort:false},			 		
					 	{title:"[[#{screen.text.aset.nm}]]"   			, field:"asetNm"	 		, hozAlign:"left"		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.type1}]]"			, field:"asetTypeNm1"	, hozAlign:"left"  		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.type2}]]"			, field:"asetTypeNm2"	, hozAlign:"left"  		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.type3}]]"			, field:"asetTypeNm3"	, hozAlign:"left"  		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.mftco}]]"	   		, field:"mftco" 				, hozAlign:"left"		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.md}]]"	   			, field:"model"				, hozAlign:"left"		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.sn}]]"	   			, field:"sn"					, hozAlign:"left"  		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.bizDept}]]"  	, field:"bizDeptNm"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.dept}]]"	   		, field:"deptNm"			, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.chrgr}]]"	   		, field:"chrgrNm"			, hozAlign:"center" 	, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.bsplc}]]"	   		, field:"bsplcNm"			, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.buld}]]"	   		, field:"buldNm"			, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.floor}]]"	   		, field:"floorNm"			, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.loc}]]"	   			, field:"loc"					, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.expDeptCd}]]", field:"expDeptNm"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.expAcct}]]"		, field:"expAcctNm"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.durYear}]]"		, field:"durYear"			, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.acqPrc}]]"	   	, field:"acqPrc"				, hozAlign:"right" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.svalPrc}]]"	   	, field:"svalPrc"			, hozAlign:"right" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.acqDt}]]"	   		, field:"acqDt"				, hozAlign:"center" 	, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop1}]]"	, field:"dtlInfo1"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop2}]]"	, field:"dtlInfo2"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop3}]]"	, field:"dtlInfo3"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop4}]]"	, field:"dtlInfo4"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop5}]]"	, field:"dtlInfo5"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop6}]]"	, field:"dtlInfo6"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop7}]]"	, field:"dtlInfo7"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop8}]]"	, field:"dtlInfo8"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop9}]]"	, field:"dtlInfo9"				, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop10}]]"	, field:"dtlInfo10"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop11}]]"	, field:"dtlInfo11"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop12}]]"	, field:"dtlInfo12"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop13}]]"	, field:"dtlInfo13"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop14}]]"	, field:"dtlInfo14"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop15}]]"	, field:"dtlInfo15"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop16}]]"	, field:"dtlInfo16"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop17}]]"	, field:"dtlInfo17"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop18}]]"	, field:"dtlInfo18"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop19}]]"	, field:"dtlInfo19"		, hozAlign:"left" 		, headerHozAlign:"center"},
					 	{title:"[[#{screen.text.aset.aset.prop20}]]"	, field:"dtlInfo20"		, hozAlign:"left" 		, headerHozAlign:"center"},
						{title: "[[#{screen.text.aset.upload.valid}]]"	, field: "chkResult"	, hozAlign:"left"  		, headerHozAlign:"center"},
						{ title: "", field: "isError", visible:false},
				 	],
				});		
				
				/*---------------------- UI Events ----------------------*/
				
				$("#addFile").on("click", function(){					
					$("#upFile").val("");
					$("#upFile").click();
				});
				
				$("#upFile").on("change", function(e){
					var obj = e.target? e.target:e.srcElement;
					var addFiles = obj.files;
					excelUpData.append("file",addFiles[0]);
					$("[name='excelNm']").val(addFiles[0].name);
				});				
				
				//일괄업로드
				$("#btnUpload").on("click", function(){					

					if($("#excelNm").val() == "") {
						alert("[[#{screen.info.status.error.outofbook.no.upload.file}]]");
						return;
					}
					
					//그리드 초기화
					batchGrid.replaceData();
					
					let url = "/asset/regist/invest/popup/uploadAset";
					let reqType = "POST";	
					$.commRequestFile(url, reqType, excelUpData)
						.then((res) => {
							
							$("#uploadCnt").html("Total : " + res.size);
							
							//PO번호 셋팅							
							res.data.forEach(row =>{
								row.poNo = "[[${poNo}]]";
							});

							console.log(res.data);
							batchGrid.setData(res.data);
						})
						.catch((error) => {
							alert('[[#{screen.info.status.error.occur}]]');						
						});
				});				
				
				//오류건만 보기 
				$("#btnError").on("click",function(){ 
					let status = $("#btnError").html();
					if(status == "[[#{screen.btn.error.list}]]"){
						batchGrid.setFilter("isNull", "=", "Y");
						$("#btnError").html("[[#{screen.btn.all.list}]]");
					}else{
						batchGrid.removeFilter("isNull", "=", "Y");
						$("#btnError").html("[[#{screen.btn.error.list}]]");
					}
				});								
				
				//저장
				$("#btnSave").on("click",function (){ 				
					let invalidData = batchGrid.searchData("isError", "=", "Y");
					let gridData = batchGrid.getData();
	    	    	
					//등록 가능한 자산 수량 체크
					if(gridData.length > remainQty) {
						alert('[[#{screen.info.status.error.aset.exceed.asset.qty}]]');
						return;
					}
					
					if(invalidData.length == 0){
		    	    	let params = {
			    	    		url : "/asset/regist/invest/popup/saveUploadAset",
			    	    		reqType : 'POST',
			    	    		data : JSON.stringify(gridData),
			    	    	}											
						
						$.request(params)
							.then((res) => {
								//window.opener.search();
								//window.close();
							})
							.catch((error) => {
								alert('[[#{screen.info.status.error.occur}]]');	
							}); 
					}else{
						alert("[[#{screen.info.status.error.outofbook.upload.invalid}]]");
					}
		        });
				
				//팝업창 닫기
				$("#btn_close_pop").on("click",function(){ 
					window.close();
				});				
				
				//양식다운로드
				$(".btn_download").on("click", function(){
					excelFormDownload();
				});				
				
			});
			
			//파일 다운로드
			function excelFormDownload() {				
				var fileName = "upload_regAset.xlsx";
				var orgFileName = "자산일괄업로드양식.xlsx";				
				var downUrl = "/file/download";
	        	var $form = $('<form></form>'); 	        	
				$form.attr('action', downUrl); 
				$form.attr('target','#downTarget'); 
				$form.attr('method','post'); 
				$form.appendTo('body'); 
				var str = $("<input type='hidden' name='fileName' value='"+fileName+"'/>");
				var str2 = $("<input type='hidden' name='orgFileName' value='"+orgFileName+"'/>");
				$form.append(str).append(str2);
				$form.submit(); 		
			}
		</script>			

	</th:block>

	<div layout:fragment="content">
		<div id="pop_wrap" style="width:1200px;height:594px;">
				<!-- head -->
				<h3>[[#{screen.text.inv.mng.upload.screen.title}]]
				<a href="#;" id="btn_close_pop"  class="pop_close" title="[[#{screen.text.comm.close}]]">[[#{screen.btn.close}]]</a>
				</h3>
				<!-- //head -->
				
				<!-- contents -->
				<div id="contents">
	
					<!-- 일괄업로드 -->
					<table class="form_table_NLine">
						<colgroup>
							<col style="width:15%;">
							<col style="width:25%;">
							<col style="width:15%;">
							<col>
						</colgroup>
						<tbody>
							<tr class="line">
								<th>[[#{screen.text.aset.file.template}]]</th>
								<td><a href="#;" class="btn_download">[[#{screen.text.comm.download.sample}]]</a></td>
								<th>[[#{screen.text.aset.file.upload}]]</th>
								<td>
									<input type="text" name="excelNm" id="excelNm" style="width:200px" readOnly >
									<input type="file" id="upFile" accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;">
									<a href="#;" id="addFile" class="btn_srch">[[#{screen.text.comm.file.search}]]</a>																	
								</td>
							</tr>
						</tbody>
					</table>
					<!-- //일괄업로드 -->
					
					<p class="space10"></p>
					
					<!-- list 1 -->
					<div class="list_wrap">
						
						<!-- list_head -->
						<div class="list_head">
							<div id="uploadCnt" class="result">Totals : 0,000</div>
							<div class="button">
								<a id="btnUpload" class="btn_list_rd">[[#{screen.btn.upload}]]</a>							
								<a id="btnError" class="btn_icon_list" href="#;">[[#{screen.btn.error.list}]]</a>
								<a href="#;" id="btnSave" class="btn_add">[[#{screen.text.comm.save}]]</a>
							</div>
						</div>
						<!-- //list_head -->
					
						<div id="batch-table"></div>
						
					</div>
					<!-- //list 1 -->
	
				</div>
				<!-- contents -->
		</div>
		<!-- //pop_alert -->
		<div id="downTarget" style="display:none;"></div>
	</div>			
</html>