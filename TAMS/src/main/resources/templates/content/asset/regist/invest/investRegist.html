<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="layout/default">

	<head>
	    <title>[[#{screen.text.inv.screen.title}]]</title>
	</head>
        
	<!-- css -->
	<th:block layout:fragment="css">
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/jsgrid.css" />
		<link rel="stylesheet" href="/css/theme.css" />
		
	</th:block>
	
	<th:block layout:fragment="script">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
		<script src="/js/jsgrid/db.js"></script>
	    <script src="/js/jsgrid/jsgrid.core.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-indicator.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.sort-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.field.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.text.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.number.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.select.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.checkbox.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.control.js"></script>	
		
	    <script>
	    
			const SCREEN_NM = "INVEST_REG_RIST";    
		    
		    // 공통코드(자산유형 1레벨 출력)
		    let numOfRows = 20;
		    let menuId = "[[${menuId}]]";
		    
		 	var condition = {};
		 	var prevCondition = {};
		 	
		    $(function(){
		    	
		    	//Local Storage에 저장된 파라미터 정보
		    	let loadParams;
		    	
		    	if("[[${loadParams}]]" == 'Y'){ //등록자산 목록에서 화면전환시
		    		loadParams = $.commLoadSearchParams(SCREEN_NM);
		    	}else{
		    		$.commRemoveSearchParams(SCREEN_NM); //메뉴클릭시	    		
		    	}
		    	
	            if(loadParams != null){
	            	
	                prevCondition = loadParams.condition.params;
	                
	    	        if(Object.keys(prevCondition).length != undefined){
	    	        	$("#invNo").val(prevCondition.invNo);
	    	        	$("#invTtl").val(prevCondition.invTtl);
	    	        	$("#poNo").val(prevCondition.poNo);
	    	        	$("#mfgdNm").val(prevCondition.mfgdNm);
	    	        	$("#deptCd").val(prevCondition.deptCd);
	    	        	$("#deptNm").val(prevCondition.deptNm);	    	        	
	    	        	$("#invReqr").val(prevCondition.invReqr);
	    	        	$("#fromDate").val(loadParams.fromDate);
	    	        	$("#toDate").val(loadParams.toDate);
	    	        	$("#regYn").val(prevCondition.regYn);
	    	        } 
	            }
		    	
		        $("#jsGrid").jsGrid({
		        	height: "550",
	                width: "100%",
	                filtering: false,
	                editing: true,
	                inserting: true,
	                sorting: true,
	                paging: true,
	                sorter: "number",
	                pageIndex:1,
	                pageFirstText:'<a class="first"><img src="/images/common/btn_pn_first.gif"></img></a>',
	                pagePrevText: '<a class="pre"><img src="/images/common/btn_pn_pre.gif"></img></a>',
	                pageNextText: '<a class="next"><img src="/images/common/btn_pn_next.gif"></img></a>',
	                pageLastText: '<a class="last"><img src="/images/common/btn_pn_last.gif"></img></a>',
	                pagerFormat: "{first} {prev} {pages} {next} {last}",
	                pagerContainer:null,
	                pageLoading: true,
	                pager: "#pager",
	                autoload: true,
	                pageSize: numOfRows,
	                pageButtonCount: 5,
	                loadonce: true,
	                updateOnResize: true, 
		            rowClick: function(args) {
		            	var target = args.event.target;
		            	
						if(target instanceof HTMLTableCellElement) {							
							openAsetList(args.item);							
						}
		            }, 
		            pagerContainerClass: "paginate",
		            deleteConfirm: function(item) {
		                return "\""+item.menuNm+"("+menuId+")"+"\""+ "[[#{screen.info.status.delete.yn}]]";
		            },
		            controller:  {
		                loadData: function(filter) {
		                    var d = $.Deferred();
		                    
		                    let url = "/asset/regist/invest/investReg/investRegList";
							let reqType = 'POST';
							let params = getParams();
		                    params.sortField = filter.sortField;
		                    params.sortOrder = filter.sortOrder;
		                    
							$.commRequest(url, reqType, JSON.stringify(params))
								.then((res) => {
									console.log(res);
									$(".result").text("Totals : " + res.condition.totalCount);
									d.resolve({data : res.data, itemsCount: res.condition.totalCount});
									currentPage = res.condition.currentPage;
									condition = res.condition;
								})
								.catch((error) => {
									console.log('[[#{screen.info.status.error.search}]]');
								});						
		                    
		                    return d.promise();
		                },
	            },
		            fields: [
		            	{ name: "invNo"    , type: "text", width: 70 , align: "center"  , title: "[[#{screen.text.inv.no}]]"    },
		                { name: "invTtl"   , type: "text", width: 170, align: "left"  , title: "[[#{screen.text.inv.ttl}]]"   },
		                { name: "invDt"    , type: "text", width: 80, align: "center"  , title: "[[#{screen.text.inv.dt}]]"    },
		                { name: "poNo"	   , type: "text", width: 80, align: "center"  , title: "[[#{screen.text.po.no}]]"     },
		                { name: "mfgdNm"   , type: "text", width: 130, align: "left"  , title: "[[#{screen.text.po.mfgdnm}]]" },
		                { name: "qty"	   , type: "text", width: 50 , align: "right"  , title: "[[#{screen.text.po.qty}]]"    },
		                { name: "poAmt"    , type: "text", width: 80, align: "right"  , title: "[[#{screen.text.po.amt}]]"    },
		                { name: "deptNm"   , type: "text", width: 100, align: "left"  , title: "[[#{screen.text.dept.nm}]]"   },
		                { name: "userNm"   , type: "text", width: 80, align: "center"  , title: "[[#{screen.text.inv.reqr}]]"  },
		                { name: "invReqr"  , type: "text", width: 80, align: "right"  , title: "[[#{screen.text.inv.reqr}]]",  visible: false },
		                { name: "asetQty"  , type: "text", width: 80, align: "right"  , title: "[[#{screen.text.inv.asetqty}]]",
		                  itemTemplate: function(value, item) {
		                    return '<a href="javascript:void(0);" onclick="openAsetList(' + item.poNo + ');">' + value + '</a>';
		                  }
		                },
		                { name: "noAsetQty", type: "text", width: 80, align: "right"  , title: "[[#{screen.text.inv.noasetqty}]]"  },
		                { name: "newYn", type: "text", visible:false},
		            ]
		        });
		        
	    	    $(".btn_srch").on("click",function (){
	    	    	if (validationCheck() == '202') {
		    	   		$("#jsGrid").jsGrid().trigger("loadData");
	    	    	}
		        });
		        
	    	    //팝업창 닫기
				$("#btn_close_pop").on("click",function(){ 
					window.close();
				});
		        
	          	//리셋 버튼
	    	    $(".btn_reset").click(function() {
	    	    	$("#invNo").val("");
	    	    	$("#invTtl").val("");
	    	    	$("#poNo").val("");
	    	    	$("#mfgdNm").val("");
	    	    	$("#deptNm").val("");
	    	    	$("#deptCd").val("");
	    	    	$("#userNm").val("");
	    	    	$("#userId").val("");
	    	    	$("#fromDate").val("");
	    	    	$("#toDate").val("");
	    	    	$("#regYn").val("");
	    	    });
	          	
				//담당자 
	    	    $("#openUserFilterPopup").on("click", function() { 	    	    	
	    	        var url = "/common/popup/userFilterPopup";
	    	        var popId = "userPopup";
	    	        var args = {
	    	        	width  : 800,	
	    	        	height : 416,
	    	        };	    	        
	    	        var param = {userId:"#userId", userNm:"#userNm"};	    	        
	    	        openPopup2("userPopup", url, args, param);	    	    	
	    	    });
				
	    	  	//부서
	     	    $("#openDeptPopup").on("click", function() { 
	     	    	let url = "/common/popup/deptTreePopup";
	     	    	let args = {
		     	    		width  : 500, 
		     	    		height : 450,
		     	    	};	    	        
	     	    	let param = {
	    	        	searchType:"DEPT", 
	    	        	deptCd:"#deptCd", 
	    	        	deptNm:"#deptNm"
	    	        };	    	        
	    	        openPopup2("DeptPopup", url, args, param);
	     	    });
	     	    
	     	    $("#excelDown").on("click",function() {	       					       
	                let url = "/asset/regist/invest/invListExcel";
	                $.commExcelDown(url, getParams());							
				});
	    	});

			function enterkey() {
		    	if (window.event.keyCode == 13) {
		    		if (validationCheck() == '202') {
		    			$("#jsGrid").jsGrid().trigger("loadData");
		    		}
		        }
		    }
			 
			// 유효성 검사
		    function validationCheck() {
		    	let code = '202';				
		    	let fromDate = $("#fromDate").val().replaceAll("-", "");
		    	let toDate = $("#toDate").val().replaceAll("-", "");
		    	
				if(fromDate > toDate) {
					alert("[[#{screen.info.status.date.fail}]]");
					$("#toDate").focus();
					code = '200';
				}
				return code;
		    }
			
		    function returnResult(item) {
				opener.selectAsetList(item);
				window.close();
		    }
		    
		    function openAsetList(val){

		       	event.preventDefault();
		       	
		       	let saveParams = {
		       		"condition": condition,
		       		"fromDate" : $("#fromDate").val(), 
		       		"toDate"   : $("#toDate").val(),
		       		"menuId"   : "[[${menuId}]]" ,
		       		"menuNm"   : "[[${menuNm}]]",
		       		"menuDesc" : "[[${menuDesc}]]",
		       		"newYn"    : val.newYn,
		       	}
		       	
		       	$.commSaveSearchParams(SCREEN_NM, saveParams);
		       	
	            let url = "/asset/regist/invest/regAset";
				let menuId = "[[${menuId}]]";
	            
				var $form = $('<form></form>'); 
					$form.attr('action', url); 
					$form.attr('method', 'Post'); 
					$form.attr('target', '_self'); 
					
				var inputStr = $('<input type="hidden" value="' + val.poNo + '" name="poNo">');
					$form.append(inputStr);
	 				inputStr = $('<input type="hidden" value="' + menuId + '" name="menuId">');
					$form.append(inputStr); 					
					$form.appendTo('body'); 					
					$form.submit();
		    }
		    
	        function getParams(){
	            return {
	                    "currentPage": $("#jsGrid").jsGrid("option", "pageIndex"),
	    				"numOfRows"    : numOfRows,
	    				"invNo"   	   : $("#invNo").val(),
	    				"invTtl"   	   : $("#invTtl").val(),
	    				"poNo"         : $("#poNo").val(),
	    				"mfgdNm"   	   : $("#mfgdNm").val(),
	    				"deptCd"       : $("#deptCd").val(),
	    				"userId"   	   : $("#userId").val(),
	    			    "fromDate"     : $("#fromDate").val().replaceAll("-", ""),
					    "toDate"       : $("#toDate").val().replaceAll("-", ""),
					    "regYn"	   	   : $("#regYn").val()             
	                 }
	         }   
	    
	    </script>	
	</th:block>

	<div layout:fragment="content">
	<!-- [D] 현재 팝업창 크기는 600*600 입니다. 콘텐츠에 따라서 크기를 변경하여 주십시오.-->
			<!-- contents_head -->
			<div class="bc">Home &gt; <span th:text="${menuDesc}"></span></div>
			<h3><span th:text="${menuNm}"></span></h3>
			<!-- //contents_head -->
			<!-- contents -->
			<div id="contents">
			
				<!-- search -->
				<div class="srch_wrap">
					<!-- search_form -->
					<div class="srch_form">
						<table class="srch_table">
							<colgroup>
								<col width="10%"/>
								<col width="20%"/>
								<col width="15%"/>
								<col width="20%"/>
								<col width="15%"/>
								<col width=""/>
							</colgroup>
							<tr>
								<th>[[#{screen.text.inv.no}]]</th>
								<td><input type="text" id="invNo" onkeyup="enterkey()" style="width:100%;"></td>
								<th>[[#{screen.text.inv.ttl}]]</th>
								<td><input type="text" id="invTtl" onkeyup="enterkey()" style="width:100%;"></td>
								<th>[[#{screen.text.po.no}]]</th>
								<td><input type="text" id="poNo" onkeyup="enterkey()" style="width:100%;"></td>
							</tr>
							<tr>
								<th>[[#{screen.text.po.mfgdnm}]]</th>
								<td><input type="text" id="mfgdNm" onkeyup="enterkey()" style="width:100%;"></td>
								<th>[[#{screen.text.dept.nm}]]</th>
								<td th:if="${session.MenuRoleCheck.roleId}=='ROLE_ADMIN'">
									<input type="hidden" id="deptCd"/>
									<div class="inqr_popup_btn">
										<input type="text" id="deptNm" style="width:100%; border-right: 1px none;" />
										<a href="#" id="openDeptPopup" ><img title="사용자검색" class="ico_search" alt="Search" src="/images/common/ico_search.png"></a>
									</div>
								</td>
								<td th:if="${session.MenuRoleCheck.roleId}!='ROLE_ADMIN'">
									<input type="text" id="deptNm" style="width:100%;" />
								</td>
								<th>[[#{screen.text.inv.reqr}]]</th>
								<td>
									<input type="hidden" id="userId"/>
									<input type="text" id="userNm" style="width:91%; border-right: 1px none;" />
									<a href="#" id="openUserFilterPopup" ><img title="사용자검색" class="ico_search" alt="Search" src="/images/common/ico_search.png"></a>
								</td>
							</tr>
							<tr>
								<th>[[#{screen.text.inv.dt}]]</th>
								<td>
								<div class="form_wrap_date"><input type="date" id="fromDate" class="aset_date"><input type="date" id="toDate" class="aset_date"></div>
								</td>
								<th>[[#{screen.text.inv.asetinqr}]]</th>
								<td>
									<select id="regYn" style="width:100%;">
										<option value="">[[#{screen.text.comm.choice}]]</option>
										<option value="Y">Y</option>
										<option value="N">N</option>
									</select>
								</td>
								<td colspan="2"></td>
							</tr>
						</table>
						<!-- search_button -->
						<div class="button">
							<a href="#;" class="btn_reset">[[#{screen.btn.reset}]]</a>
							<a href="#;" class="btn_srch">[[#{screen.btn.search}]]</a>										
										
						</div>
						<!-- //search_button -->
					</div>
					<!-- //search_form -->
				</div>
				<!-- //search -->			
	
				<div class="list_head">
					<div class="result">Totals : 0,000</div>
					<div class="button">
						<a class="btn_sel" id="excelDown">[[#{screen.btn.excel}]]</a>
					</div>
					<!-- list_button -->
				</div>
				<div id="jsGrid"></div>
			</div>
			
			<div id="excelDownTarget"></div>
			
		</div>
</html>