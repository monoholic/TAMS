<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="layout/default">

	<head>
	    <title>[[#{screen.text.outofbook.screen.title}]]</title>
	</head>
        
	<!-- css -->
	<th:block layout:fragment="css">	
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/theme.css" />
		<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.8/css/tabulator.min.css" rel="stylesheet"> 
	</th:block>        
	
	<th:block layout:fragment="script">
		<script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
		<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.0.7/dist/js/tabulator.min.js"></script>
		
	    <script>
	    
		    // 공통코드(자산유형 1레벨 출력)
		    let menuId = "[[${menuId}]]";		    
		    let grid;
		 	
		    $(function(){
		    	
		    	//자산유형1
		    	getCommCode("#asetType1", "AS_CLASS", "1", "");
		    	
				grid = new Tabulator("#data-table", {
				 	locale:true,
				    langs: $.commGridLocalization(),								
				 	height:"95%",
				 	layout:"fitColumns",
				 	movableColumns:true,
				 	pagination:true,
				 	paginationMode:"remote",
				 	ajaxURL:"/asset/regist/invest/investReg/investRegList",			
				 	ajaxParams: getParams(),
				 	paginationSize:20,				    
				 	paginationSizeSelector:[20, 50, 100, 500],			
				 	dataSendParams:{
				        "page":"currentPage",
				        "size":"numOfRows"
				    } ,							    
				 	placeholder:"No Data Set",				 	
				 	ajaxResponse:function(url, params, res){
				 		$(".result").text("Totals : " + res.condition.totalCount);
						condition = res.condition;				 						 		
				 		return res;
				 	},					 	
				 	columns:[ 
					 	{title:"[[#{screen.text.inv.no}]]"		 , field:"invNo"	, hozAlign:"center", headerHozAlign:"center"},
					 	{title:"[[#{screen.text.inv.ttl}]]"		 , field:"invTtl"	, hozAlign:"left"  , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.inv.dt}]]"		 , field:"invDt" 	, hozAlign:"center", headerHozAlign:"center"},
					 	{title:"[[#{screen.text.po.no}]]"	 	 , field:"poNo"		, hozAlign:"center", headerHozAlign:"center"},
					 	{title:"[[#{screen.text.po.mfgdnm}]]"	 , field:"mfgdNm"	, hozAlign:"left"  , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.po.qty}]]"	 	 , field:"qty"		, hozAlign:"right" , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.po.amt}]]"	 	 , field:"poAmt"	, hozAlign:"right" , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.dept.nm}]]"	     , field:"deptNm"	, hozAlign:"left"  , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.inv.reqr}]]"	 , field:"userNm"	, hozAlign:"center", headerHozAlign:"center"},
					 	{title:"[[#{screen.text.inv.asetqty}]]"	 , field:"asetQty"	, hozAlign:"right" , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.inv.noasetqty}]]", field:"noAsetQty", hozAlign:"right" , headerHozAlign:"center"},
					 	{title:"[[#{screen.text.inv.reqr}]]"	 , field:"invReqr"	, visible:false },					 	
					 	{title:"newYn"							 , field:"newYn" 	, visible:false},
				 	],
				});						

				/*------------- Grid Events -------------*/
				//row click
				grid.on("rowClick", function(e, row){	
					var rowData = row.getData();					
					openAsetList(row.getData());
				});	
				
				
				/*------------- UI Events -------------*/
				
		      	//자산유형1 change 이벤트
		        $("#asetType1").change(function(){
		        	let type1 = $("#asetType1").val();

	        		$('#asetType2').children('option:not(:first)').remove();
	        		$('#asetType3').children('option:not(:first)').remove();
	        		
		        	if(type1 != 'ALL') {
		        		getCommCode("#asetType2", "AS_CLASS", "2", type1);
		        	}
		        });
		        
		        //자산유형2 change 이벤트
		        $("#asetType2").change(function(){
		        	let type2 = $("#asetType2").val();
		        	
		        	$('#asetType3').children('option:not(:first)').remove();
		        	
		        	if(type2 != 'ALL') {		        		
		        		getCommCode("#asetType3", "AS_CLASS", "3", type2);
		        	}
		        });					
				
				
	         	//조회
	    	    $(".btn_srch").on("click",function (){
	    	    	grid.replaceData();
		        });
		        
	    	    //팝업창 닫기
				$("#btn_close_pop").on("click",function(){ 
					window.close();
				});
		        
	          	//리셋 버튼
	    	    $(".btn_reset").click(function() {
	    	    	let elements = ['asetNo', 'fromDate', 'toDate', 'bizDeptCd', 'bizDeptNm', 'deptCd', 'deptNm', 'userNm']

	    	    	elements.forEach((item) => {$("#"+item).val('')});
	    	    	
	    	    	$('#asetType1').val("ALL").attr("selected", "selected");
	    	    	$('#asetType2').children('option:not(:first)').remove();
	    	    	$('#asetType3 ').children('option:not(:first)').remove();	    	    	
	    	    });
	          	

    	        let dept_pop  = "DeptPopup";	          	
    	        let dept_url  = "/common/popup/deptTreePopup";
    	        let dept_args = {width:500, height:450,};	 	          	
	          	
    	        //사업부 조회
	     	    $("#bizDeptPopup").on("click", function() {
			     	var params = {
	        	        searchType:"BIZ_DEPT",
	     	        	deptCd:"#bizDeptCd",
	     	        	deptNm:"#bizDeptNm" 	  	        	        	         	    		
	         	    }; 	        		        	        
	        	    openPopup2(dept_pop, dept_url, dept_args, params);
	         	 });	
    	        
    	        //부서 조회
	     	    $("#deptPopup").on("click", function() {
			     	var params = {
	        	        searchType:"DEPT",
	     	        	deptCd:"#deptCd",
	     	        	deptNm:"#deptNm" 	  	        	        	         	    		
	         	    }; 	        		        	        
	        	    openPopup2(dept_pop, dept_url, dept_args, params);
	         	 });	     	    
    	        
    	        
	    	  	//엑셀 다운로드
	     	    $("#excelDown").on("click",function() {	       					       
	     	    	grid.download("xlsx", "InvestAsset.xlsx", {sheetName:"투자자산"});
				});
	    	});

		    //공통코드-selectbox
			function getCommCode(id, code, level, upperCodeId){				
				let url = "/common/comm/selectBox";
				let reqType = 'GET';
				$.commRequestSelectbox(url, reqType, id, code, level, upperCodeId);			
			}
					    
		    
		    //엔터		    
			function enterkey() {
		    	if (window.event.keyCode == 13) {
		    		if (validationCheck() == '202') {
		    			grid.replaceData();
		    		}
		        }
		    }
			 
			// 유효성 검사
		    function validationCheck() {
		    	let code = '202';				
		    	let fromDate = $("#fromDate").val().replaceAll("-", "");
		    	let toDate = $("#toDate").val().replaceAll("-", "");
		    	
				if(fromDate > toDate) {
					alert("[[#{screen.info.status.date.fail}]]");
					$("#toDate").focus();
					code = '200';
				}
				return code;
		    }

		    //검색조건
	        function getParams(){
	            return {
	    				"invNo"   	   : $("#invNo").val(),
	    				"invTtl"   	   : $("#invTtl").val(),
	    				"poNo"         : $("#poNo").val(),
	    				"mfgdNm"   	   : $("#mfgdNm").val(),
	    				"deptCd"       : $("#deptCd").val(),
	    				"userId"   	   : $("#userId").val(),
	    			    "fromDate"     : $("#fromDate").val().replaceAll("-", ""),
					    "toDate"       : $("#toDate").val().replaceAll("-", ""),
					    "regYn"	   	   : $("#regYn").val()             
	                 }
	         }   
	    
	    </script>	
	</th:block>

	<div layout:fragment="content">
		<!-- contents_head -->
		<div class="bc">Home &gt; <span th:text="${menuDesc}"></span></div>
		<h3><span th:text="${menuNm}"></span></h3>
		<!-- //contents_head -->
		
		<!-- search -->
		<div class="srch_wrap">
			<!-- search_form -->
			<div class="srch_form">
				<table class="srch_table">
					<colgroup>
						<col width="10%"/>
						<col width="20%"/>
						<col width="15%"/>
						<col width="20%"/>
						<col width="15%"/>
						<col width=""/>
					</colgroup>
					<tr>
						<th>[[#{screen.text.outofbook.asetNo}]]</th>
						<td><input type="text" id="asetNo" onkeyup="enterkey()" style="width:100%;"></td>
						<th>[[#{screen.text.outofbook.regDt}]]</th>
						<td colspan="3">
							<div class="form_wrap_date">
								<input type="date" id="fromDate" class="aset_date" style="width:17%;">
								-&nbsp;
								<input type="date" id="toDate" class="aset_date" style="width:17%;">
							</div>
						</td>
					</tr>
					<tr>
						<th>[[#{screen.text.outofbook.asetType1}]]</th>
						<td>
							<select id="asetType1" style="width:100%;">
								<option>ALL</option>
							</select>						
						</td>
						<th>[[#{screen.text.outofbook.asetType2}]]</th>
						<td>
							<select id="asetType2" style="width:100%;">
								<option>ALL</option>
							</select>
						</td>
						<th>[[#{screen.text.outofbook.asetType3}]]</th>
						<td>
							<select id="asetType3" style="width:100%;">
								<option>ALL</option>
							</select>
						</td>
					</tr>					
					<tr>
						<th>[[#{screen.text.outofbook.bizDept}]]</th>
						<td th:if="${session.MenuRoleCheck.roleId}=='ROLE_ADMIN'">
							<input type="hidden" id="bizDeptCd"/>
							<div class="inqr_popup_btn">
								<input type="text" id="bizDeptNm" style="width:100%; border-right: 1px none;" readonly />
								<a href="#" id="bizDeptPopup" ><img title="사업부 검색" class="ico_search" alt="Search" src="/images/common/ico_search.png"></a>
							</div>
						</td>
						<td th:if="${session.MenuRoleCheck.roleId}!='ROLE_ADMIN'">
							<input type="hidden" id="bizDeptCd"/>
							<input type="text" id="bizDeptNm" style="width:100%;" />
						</td>		
						<th>[[#{screen.text.outofbook.dept}]]</th>
						<td th:if="${session.MenuRoleCheck.roleId}=='ROLE_ADMIN'">
							<input type="hidden" id="deptCd"/>
							<input type="text" id="deptNm" style="width:91%;" readonly/>							
							<a href="#" id="deptPopup" >
								<img title="부서 검색" class="ico_search" alt="Search" src="/images/common/ico_search.png">
							</a>
						</td>						
						<td th:if="${session.MenuRoleCheck.roleId}!='ROLE_ADMIN'">
							<input type="hidden" id="deptCd"/>
							<input type="text" id="deptNm" style="width:91%;" readonly/>						
						</td>
						<th>[[#{screen.text.outofbook.charger}]]</th>
						<td>
							<input type="text" id="userNm" style="width:100%; border-right: 1px none;" />
						</td>
					</tr>
				</table>
				<!-- search_button -->
				<div class="button">
					<a href="#;" class="btn_reset">[[#{screen.btn.reset}]]</a>
					<a href="#;" class="btn_srch">[[#{screen.btn.search}]]</a>										
								
				</div>
				<!-- //search_button -->
			</div>
			<!-- //search_form -->
		</div>
		<!-- //search -->			

		<div class="list_head">
			<div class="result">Totals : 0,000</div>
			<div class="button">
				<a class="btn_list_rd" id="excelDown">[[#{screen.btn.excel}]]</a>
			</div>
			<!-- list_button -->
		</div>
		<div id="data-table"></div>
		</div>

</html>