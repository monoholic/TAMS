<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="layout/default">

	<head>
	    <title>[[#{screen.text.modify.screen.title2}]]</title>
	</head>
        
	<!-- css -->
	<th:block layout:fragment="css">
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/jsgrid.css" />
		<link rel="stylesheet" href="/css/theme.css" />
	</th:block>
	
	<th:block layout:fragment="script">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
		<script src="/js/jsgrid/db.js"></script>
	    <script src="/js/jsgrid/jsgrid.core.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-indicator.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.sort-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.field.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.text.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.number.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.select.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.checkbox.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.control.js"></script>	
		
	    <script>
    	let numOfRows = 30; //basic = 30
    	const SCREEN_NM = "INSP_MANAGE_LIST";
    	
    	var selectedItems = [];
    	var inspStusArr   = [];
    	var inspMtdArr    = [];
    	var inspCmplYnArr = [];
    	var inspPtclArr   = [];
	    

        var selectItem = function(item) {
	    	if(!selectedItems.includes(item)) selectedItems.push(item);
	    	
		    if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
	        } else {
	            $("#selectAllCheckbox").prop("checked", false);
	        }
		};
	     
	    var unselectItem = function(item) {
		    selectedItems = $.grep(selectedItems, function(i) {
		    	return i !== item;
		    });
		    if(selectedItems.length == 0) {
		    	$('#selectAllCheckbox').attr('checked', false);
		    }
		    if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
             	$("#selectAllCheckbox").prop("checked", true);
         	} else {
            	$("#selectAllCheckbox").prop("checked", false);
          	}
	    };
    	
	    $(function(){
	    	
	    	loadParams = $.commLoadSearchParams(SCREEN_NM);

	    	
	    	// 셀렉트박스조회 > 그리드 로드 > 실사기본정보 조회 > 그리드 데이터 조회  
	    	selectInspAsetCodeList().done(function(msg){ // 셀렉트박스 코드 조회 
	    		jsGridLoad();
		    	// 자산실사 기본정보 조회
		    	selectInspManageList().done(function(msg){ // 실사기본정보 조회 
		    		$("#jsGrid").jsGrid("loadData");
		    	});
	    	});
	    	
	    	
	        $("#pager").on("change", function() {
	            var page = parseInt($(this).val(), 10);
	            $("#jsGrid").find(".jsgrid-table").append("<tr class='jsgrid-row'></tr>");
	        });
	        
	        // 상단 저장 버튼 
            $('.btn_save1').on('click', function (e) {
            	var d = $.Deferred();
	  	    	
	  	    	//별도 호출
                let url = "/asset/insp/manage/updateInspMaster";  
				let reqType = 'POST';	
				let data = {
					"inspNo"          : $("#inspNo").val(),
					"inspNm"          : $("#inspNm").val(),
					"inspStDt"        : $("#inspStDt").val().replace(/-/gi, ""),
					"inspEndDt"       : $("#inspEndDt").val().replace(/-/gi, ""),
					"onlineInspBaseDt": $("#onlineInspBaseDt").val().replace(/-/gi, "")
    			}
	  			
	  			$.commRequest(url, reqType, JSON.stringify(data))
	  				.then((res) => {
	  					console.log(res);
	  					d.resolve(res);
	  					alert("[[#{screen.info.status.save.success}]]");
	  					window.location.reload();
	  				})
	  				.catch((error) => {
	  					alert("[[#{screen.info.status.error.occur}]]");
	  					console.log(error);
	  				})
				return d.promise();
            });
	        
	        // 상단 삭제버튼 
            $('.btn_del1').on('click', function (e) {
            	var d = $.Deferred();
	  	    	var items = [];
	  	    		items.push($("#inspNo").val());
	  	    	
	  	    	//별도 호출
                let url = "/asset/insp/manage/deleteInspList";  
				let reqType = 'POST';	
				let data = {
					"items": items
    			}
	  			
	  			$.commRequest(url, reqType, JSON.stringify(data))
	  				.then((res) => {
	  					console.log(res);
	  					d.resolve(res);
	  					alert("[[#{screen.info.status.delete.success}]]");
	  					requestListView();
	  				})
	  				.catch((error) => {
	  					alert("[[#{screen.info.status.error.occur}]]");
	  					console.log(error);
	  				})
				return d.promise();
            });
    	    
	        
    	    // 자산추가 버튼 클릭 
    	    $(".btn_add").click(function() {
    	        var url = "/asset/insp/manage/inspManageAsetAddPopup";
    	        var args = {width:1200, height:1050};
    	        var param = {};
    	        param.inspNo = $("#inspNo").val();
    	        console.log("[detail inspNo]"+$("#inspNo").val());
    	        openPopup2("inspManageAsetAddPopup", url, args, param);
    	    });
    	    
	     	// 그리드 저장 버튼 처리
            $('.btn_save2').on('click', function (e) {
            	e.preventDefault();
    			$("#jsGrid").jsGrid("updateItem");
            });
    	    
	     	// 그리드 삭제 버튼 처리
            $('.btn_del2').on('click', function (e) {
            	
           	    if (selectedItems.length === 0) {
           	        alert("[[#{screen.info.status.no.selected.item}]]");
           	        return;
           	    }
           	    
        		var items = [];
        		
            	var d = $.Deferred();
	  	    	$.each(selectedItems, function(index,item){
	  	    		items.push(item);
	  	    	});
	  	    	
                let url = "/asset/insp/manage/deleteInspAsetList";  
				let reqType = 'POST';	
				let data = {
    				"inspNo" 	: $("#inspNo").val(),
    				"asetNo" 	: items,
    			}
				
				$.commRequest(url, reqType, JSON.stringify(data))
					.then((res) => {
						d.resolve(res);
						alert("[[#{screen.info.status.delete.success}]]");
						$("#jsGrid").jsGrid("loadData");
					})
					.catch((error) => {
						console.log('[[#{screen.info.status.error.occur}]]');
					});						
                return d.promise();
           	    
            });
	     	
            
    	     
	        
    	});   // $(function()
    			
    	var currentRow;
    	function jsGridLoad(){

	        $("#jsGrid").jsGrid({ 
	        	height: "550",
                width: "100%",
                filtering: false,
                editing: {mode:"batch"},
                inserting: false,
                sorting: true,
                paging: true,
                sorter: "number",
                pageIndex:1,
                pageFirstText:'<a class="first"><img src="/images/common/btn_pn_first.gif"></img></a>',
                pagePrevText: '<a class="pre"><img src="/images/common/btn_pn_pre.gif"></img></a>',
                pageNextText: '<a class="next"><img src="/images/common/btn_pn_next.gif"></img></a>',
                pageLastText: '<a class="last"><img src="/images/common/btn_pn_last.gif"></img></a>',
                pagerFormat: "{first} {prev} {pages} {next} {last}",
                pagerContainer:null,
                pageLoading: true,
                pager: "#pager",
                pageSize: numOfRows,
                pageButtonCount: 5,
                loadonce: true,
                updateOnResize: true, 
	            rowClick: function(args) {
	            	targetItem = args.item;
	            	
	            	// 체크박스 선택 시 editing 활성화 막기
	            	var chkBoxNm = jQuery(".singleCheckbox").attr("class");
	            	var chkBoxNm2 = jQuery(args.event.target).attr("class");
	            	
	            	if(args.event.target.cellIndex != 0 && chkBoxNm != chkBoxNm2) {
	            		jsGrid.Grid.prototype.rowClick.call(this, args);
            	    }
	            },
	            pagerContainerClass: "paginate",
	            deleteConfirm: "[[#{screen.info.status.default.delete.yn}]]",
	            controller:  {
	            	updateItem: function(args) {
	                	var d = $.Deferred();
	                    let url = "/asset/insp/manage/updateInspAsetList";  
						let reqType = 'POST';
						let data = {
	        				"inspNo" 	: $("#inspNo").val(),
	        				"asetNo" 	: args.asetNo,
	        				"inspStus" 	: args.inspStus,
	        				"inspMtd" 	: args.inspMtd,
	        				"inspCmplYn": args.inspCmplYn,
	        				"ptcl" 	   	: args.ptcl,
	        				"rmk" 	   	: args.rmk
	        			}
						
						$.commRequest(url, reqType, JSON.stringify(data))
							.then((res) => {
								d.resolve(res);
								$("#jsGrid").jsGrid("loadData");
							})
							.catch((error) => {
								console.log('[[#{screen.info.status.error.occur}]]');
							});						
	                    return d.promise();
		            },
	                loadData: function(filter) {
	                	var d = $.Deferred();
	                    
	                    currentPage = filter.pageIndex; 
	                    let url = "/asset/insp/manage/selectInspAsetList";  
						let reqType = 'GET';	
						let data = {
            				"currentPage"  : filter.pageIndex,
            				"numOfRows"    : numOfRows, 
            				"inspNo" 	   : $("#inspNo").val(),
            				"searchOption" : $("#searchOption option:selected").val(),
            				"sortField"    : filter.sortField,
            				"sortOrder"    : filter.sortOrder
            			}
						
						$.commRequest(url, reqType, data)
							.then((res) => {
								console.log(res);
								condition = res.condition;
								inspAsetList = res.data;
								$(".result").text("Results : " + res.condition.totalCount);
								d.resolve({data : res.data, itemsCount: res.condition.totalCount});
							})
							.catch((error) => {
								console.log('[[#{screen.info.status.error.search}]]');
							});						
	                    
	                    return d.promise();
	                },

           		},
	            fields: [
	            	{  	   name : "chk"
	                	 , align: "center"
	                	 , width: 5
	                	 , title: ""
	                	 , editing: false
	                	 , sorting: false
	                	 , filtering: false
	                	 , itemTemplate: function(value, item) {
	                       return $("<input>").attr("type", "checkbox").attr("class","singleCheckbox")
	                       .prop("checked", $.inArray(item.firstName, selectedItems) > -1)
	                       .on("change", function () {
	  					  	 //$(this).is(":checked") ? selectItem($(this).parent().next().text()) : unselectItem($(this).parent().next().text());
	  					  	 $(this).is(":checked") ? selectItem(item.asetNo) : unselectItem(item.asetNo);
	  					  	 });
	            		   }
	                	 , headerTemplate : function ()  { 
						  	 return  $("<input>").attr("type", "checkbox").attr("id","selectAllCheckbox")
		                     .on("change", function (item) {
		             	    	selectedItems = [];
		            	    	if(this.checked) { 
		            	            $('.singleCheckbox').each(function() { 
		            	                this.checked = true;   
		            	                selectItem($(this).parent().next().text());           
		            	            });			         
		            	        }else {
		            	        	
		            	            $('.singleCheckbox').each(function() { 
		            	                this.checked = false;      
		            	                unselectItem(item);
		            	            });  
		            	            selectedItems = [];
		            	        }
		    				   });
					 	 } ,
	                },
	                { name:"inspNo"	    , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.inspNo}]]"},	//실사번호
	                { name:"asetNo"	    , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.asetNo}]]"},	//자산번호
	                { name:"asetType1Nm", type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.asetType1}]]"},  //자산유형1
	                { name:"asetType2Nm", type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.asetType2}]]"},  //자산유형2
	                { name:"asetType3Nm", type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.asetType3}]]"},  //자산유형3
	                { name:"mftco"	    , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.mftco}]]"},      //메이커 
	                { name:"model"	    , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.model}]]"},      //모델
	                { name:"sn"	        , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.sn}]]"},         //S/N
	                { name:"bizDeptNm"  , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.bizDeptCd}]]"},  //사업부
	                { name:"deptNm"	    , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.deptCd}]]"},     //부서
	                { name:"chrgr"	    , type:"text", align:"center", width:10,editing: false, title:"[[#{screen.text.asset.chrgr}]]"},      //담당자
	                { name:"inspStus"   , type:"select",align:"center",width:10,editing: true,  title:"[[#{screen.text.asset.inspStus}]]"  , items:inspStusArr  , valueField :"codeId", textField : "codeNm", editing: true},
	                { name:"inspMtd"    , type:"select",align:"center",width:10,editing: true,  title:"[[#{screen.text.asset.inspMethod}]]", items:inspMtdArr   , valueField :"codeId", textField : "codeNm", editing: true},
	                { name:"inspCmplYn" , type:"select",align:"center",width:10,editing: true,  title:"[[#{screen.text.asset.inspCmplYn}]]", items:inspCmplYnArr, valueField :"codeId", textField : "codeNm", editing: true},
	                { name:"ptcl"	    , type:"text", align:"center", width:10,editing: true,  title:"[[#{screen.text.asset.ptcl}]]"},       //특이사항
	                { name:"rmk"	    , type:"text", align:"center", width:10,editing: true,  title:"[[#{screen.text.asset.rmk}]]"}        //비고

	            ]
	        }); 
    	}
    			
    		
    	// 삭제 시 이전 페이지로 이동
    	function requestListView() {
    		let url = "/asset/insp/manage/list";
    		
    		var $form = $('<form></form>'); 
				$form.attr('action', url); 
				$form.attr('method', 'post'); 
				$form.attr('target', '_self'); 
				inputStr = $('<input type="hidden" value="'+ loadParams.menuId + '" name="menuId">');
				$form.append(inputStr);
				inputStr = $('<input type="hidden" value="'+ loadParams.menuNm + '" name="menuNm">');	
				$form.append(inputStr);
				inputStr = $('<input type="hidden" value="'+ loadParams.menuDesc + '" name="menuDesc">');	
				$form.append(inputStr);
				inputStr = $('<input type="hidden" value="Y" name="loadParams">');
				$form.append(inputStr);
				$form.appendTo('body'); 
				$form.submit();
	    }
    	
    	// 셀렉트박스 코드 조회
    	function selectInspAsetCodeList(){
    		
    		var d = $.Deferred();
    		
            let url = "/asset/insp/manage/selectInspAsetCodeList"; 
			let reqType = 'GET';	
			let data = {
				"currentPage"  : 0,
				"numOfRows"    : 1, 
				"sortField"    : "",
				"sortOrder"    : ""
			}
			
			$.commRequest(url, reqType, data)
				.then((res) => {
					data = res.data;
					inspStusArr = data.inspStusArr;
					inspMtdArr = data.inspMtdArr;
					inspPtclArr = data.inspPtclArr;
					inspCmplYnArr = [{codeId:"Y", codeNm:"Y"},{codeId:"N", codeNm:"N"}];
					d.resolve({data : res});
					
				})
				.catch((error) => {
					console.log('[[#{screen.info.status.error.search}]]');
				});
    		
			return d.promise();
    	}
    	
    	// 자산실사 기본정보 조회
    	function selectInspManageList(){

        	var d = $.Deferred();
            
            let url = "/asset/insp/manage/selectInspManageList"; 
			let reqType = 'GET';	
			let data = {
				"currentPage"  : 0,
				"numOfRows"    : 1, 
				"inspNo" 	   : $("#inspNo").val(),
				"sortField"    : "",
				"sortOrder"    : ""
			}
			
			$.commRequest(url, reqType, data)
				.then((res) => {
					condition = res.condition;
					inspMastList = res.data[0];
					
					// 자산실사정보란 세팅 
					$("#inspNm"   ).val(inspMastList.inspNm);
					$("#inspStDt" ).val(inspMastList.inspStDt);
					$("#inspEndDt").val(inspMastList.inspEndDt);
					$("#onlineInspBaseDt").val(inspMastList.onlineInspBaseDt);
					$("#regr"     ).val(inspMastList.regr);
					$("#regDt"    ).val(inspMastList.regDt);
					$("#inspStus" ).val(inspMastList.inspStusNm);

					d.resolve(res);
					
					// 대상자산정보 그리드 로드
					//$("#jsGrid").jsGrid("loadData");
					//jsGridLoad();
				})
				.catch((error) => {
					console.log('[[#{screen.info.status.error.search}]]');
				});						
            
            return d.promise();
    	}
    	
    	
	    
	    </script>
	</th:block>

	<div layout:fragment="content">
		<h3><span>[[#{screen.text.modify.screen.title3}]]</span></h3>
		<div class="list_head">
			<div class="list_head">
				<div><h6>[[#{screen.text.asset.asetInspInfo}]]</h6></div>
			</div>
			<div class="button">
				<a class="btn_save1">[[#{screen.text.comm.save}]]</a>
				<a class="btn_del1">[[#{screen.btn.delete}]]</a>
				<a class="btn_" id="requestBack" onclick="requestListView()">뒤로가기</a>
			</div>
		</div>
		
		<div class="srch_wrap single">
			<table class="srch_table">
				<colgroup>
					<col width="10%"/>
					<col width="20%"/>
					<col width="15%"/>
					<col width="20%"/>
					<col width="15%"/>
					<col width=""/>
				</colgroup>
				<tr>
					<th>[[#{screen.text.asset.inspNo}]]</th><!-- 실사번호 -->
					<td><input type="text" id="inspNo" style="width:100%;" th:value="${inspNo}" disabled="disabled"></td>
					<th>[[#{screen.text.asset.inspNm}]]</th><!-- 실사명 -->
					<td colspan="3"><input type="text" id="inspNm" style="width:100%;" th:value="${inspNm}" ></td>
				</tr>
				<tr>
					<th>[[#{screen.text.asset.inspStDt}]]</th><!-- 실사시작일 -->
					<td>
						<div style='display:flex'><input type="date" id="inspStDt" style="width:100%"></div>
					</td>
					<th>[[#{screen.text.asset.inspEndDt}]]</th><!-- 실사종료일 -->
					<td>
						<div style='display:flex'><input type="date" id="inspEndDt" style="width:100%"></div>
					</td>
					<th>[[#{screen.text.asset.onlineInspBaseDt}]]</th><!-- 온라인실사기준일 -->
					<td>
						<div style='display:flex'><input type="date" id="onlineInspBaseDt" style="width:100%"></div>
					</td>
				</tr>
				<tr>
					<th>[[#{screen.text.asset.inspRegr}]]</th><!-- 생성자 -->
					<td><input type="text" id="regr" disabled="disabled" style="width:100%;" th:value="${regr}"> </td>
					<th>[[#{screen.text.asset.inspRegDt}]]</th><!-- 생성일자 -->
					<td><input type="text" id="regDt" disabled="disabled" style="width:100%;" th:value="${regDt}"></td>
					<th>[[#{screen.text.asset.inspStus}]]</th><!-- 실사상태 -->
					<td><input type="text" id="inspStus" disabled="disabled" style="width:100%;" th:value="${inspStus}"></td>
				</tr>
			</table>
		</div><br>
		
		<div class="list_head" style="display: flex;">
			<div><h6>[[#{screen.text.modify.screen.title5}]]</h6></div>
			<div class="result" style="margin-left: 20px;">Results : 0,000</div>
			<div class="button">
				<a class="btn_add">[[#{screen.text.comm.add.asset}]]</a>
				<a class="btn_save2" id="save">[[#{screen.text.comm.save}]]</a>
				<a class="btn_del2">[[#{screen.btn.delete}]]</a>
			</div>
		</div>
		<div id="jsGrid"></div>
		<input type="hidden" id="curr_Idx"/>
		<div id="excelDownTarget"></div>
	</div>
</html>