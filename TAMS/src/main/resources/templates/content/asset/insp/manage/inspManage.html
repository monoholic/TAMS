<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        layout:decorator="layout/default">
       
	<head>
	    <title>[[#{screen.text.asset.asetInspList}]]</title>
	</head>
        
        
	<!-- css -->
	<th:block layout:fragment="css">
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/jsgrid.css" />
		<link rel="stylesheet" href="/css/theme.css" />
	</th:block>  
	
	<th:block layout:fragment="script">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
		<script src="/js/jsgrid/db.js"></script>
	    <script src="/js/jsgrid/jsgrid.core.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-indicator.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.sort-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.field.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.text.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.number.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.select.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.checkbox.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.control.js"></script>	
	
		<script>
		const SCREEN_NM     = "INSP_MANAGE_LIST"; 
		const REG_SCREEN_NM = "INSP_MANAGE_REG";
	    let menuId = "[[${menuId}]]";
	    let numOfRows = 30; //basic = 30
	    let invData = {};
	    
        var selectedItems = [];
	 	var insertedItems = [];
	 	var updatedItems = [];
	 	var codeGrpMngList = [];
	 	
	 	var condition = {};
	 	var prevCondition = {};
		
		$(function(){
			
	        //자산유형1 코드 조회
	        //getCommCode("#asetType1", "AS_CLASS", "1", "");
			
	        // 실사명 코드 조회
	      	getInspNmList();
	        
	      	$("#jsGrid").jsGrid("loadData");
	        
          	//리셋 버튼
    	    $(".btn_reset").click(function() {
    	    	let elements = ['inspYear', 'inspNm']
    	    	elements.forEach((item) => {$("#"+item).val('')});
    	    	$("#inspNm option:eq(0)").prop("selected",true);
    	    	//$('#asetType1').val("ALL").attr("selected", "selected");
    	    	//$('#asetType2').children('option:not(:first)').remove();
    	    });    	        
	        
          	//조회 버튼 
    	    $(".btn_srch").on("click",function (){
    	    	$("#jsGrid").jsGrid("loadData");
	        });			
          	
			//엔터키
    	    $(document).keypress(function(event){	    	    	
    	        var keycode = (event.keyCode ? event.keyCode : event.which);
    	        //console.log(event);
    	        if(keycode == '13'){
    	        	$("#jsGrid").jsGrid("loadData");
    	        }
    	    });
			
    	    // 실사 생성 버튼 클릭 
    	    $(".btn_add").click(function() {
    	        var url = "/asset/insp/manage/inspManagePopup";
    	        var args = {width:1200, height:250};
    	        var params = {};
    	        	params.inspNo = "";
    	        openPopup2("inspManagePop", url, args, params);	        	
    	    });

    	    // 삭제버튼 클릭
			$(".btn_del").click(function() {
   	    	
	  	    	var arr_item =  [];
	  	    	var items = [];
	  	    	$.each(selectedItems, function(index,item){
	  	    		items.push(item);
	  	    	});
	  	    	
	  	    	//별도 호출
	  	    	let url = "/asset/insp/manage/deleteInspList";
	  			let reqType = 'GET';
	  			dataType: 'json';
	  			let data={
	  				"items": items.join(",")
	  			}
	  			
	  			$.commRequest(url, reqType, data)
	  				.then((res) => {
	  					console.log(res);
	  					alert("[[#{screen.info.status.delete.success}]]");
	  					selectedItems = [];
	  					$('.btn_srch').click();
	  				})
	  				.catch((error) => {
	  					alert("[[#{screen.info.status.error.occur}]]");
	  					console.log(error);
	  				})
    	    });
			
	        var selectItem = function(item) {
		    	if(!selectedItems.includes(item)) selectedItems.push(item);
		    	
			    if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
	                $("#selectAllCheckbox").prop("checked", true);
		        } else {
		            $("#selectAllCheckbox").prop("checked", false);
		        }
			};
		     
		    var unselectItem = function(item) {
			    selectedItems = $.grep(selectedItems, function(i) {
			    	return i !== item;
			    });
			    if(selectedItems.length == 0) {
			    	$('#selectAllCheckbox').attr('checked', false);
			    }
			    if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
	             	$("#selectAllCheckbox").prop("checked", true);
	         	} else {
	            	$("#selectAllCheckbox").prop("checked", false);
	          	}
		    };
		    
	        $("#pager").on("change", function() {
	            var page = parseInt($(this).val(), 10);
	            $("#jsGrid").find(".jsgrid-table").append("<tr class='jsgrid-row'></tr>");
	        });
							
	        $("#jsGrid").jsGrid({
	        	height: "550",
                width: "100%",
                filtering: false,
                editing: true,
                inserting: false,
                sorting: true,
                paging: true,
                sorter: "number",
                pageIndex:1,
                pageFirstText:'<a class="first"><img src="/images/common/btn_pn_first.gif"></img></a>',
                pagePrevText: '<a class="pre"><img src="/images/common/btn_pn_pre.gif"></img></a>',
                pageNextText: '<a class="next"><img src="/images/common/btn_pn_next.gif"></img></a>',
                pageLastText: '<a class="last"><img src="/images/common/btn_pn_last.gif"></img></a>',
                pagerFormat: "{first} {prev} {pages} {next} {last}",
                pagerContainer:null,
                pageLoading: true,
                pager: "#pager",
                pageSize: numOfRows,
                pageButtonCount: 5,
                loadonce: true,
                updateOnResize: true, 
	            rowClick: function(args) {
	            	var $target = $(args.event.target); // 클릭한 셀 jquery object 
	            	var columnIdx = $target.index(); // 클릭한 셀이 몇번째 컬럼인지 저장 
	            	var inspNo =  args.item.inspNo// 해당 로우의 실사번호 
	            	
					if(columnIdx == 0) { // 체크박스 클릭 
					   	$("<input>").attr("type", "checkbox").attr("class","singleCheckbox")
					                .prop("checked", $.inArray(args.item.firstName, selectedItems) > -1)
					                .on("change", function () {
						  	 $(this).is(":checked") ? selectItem(item) : unselectItem(item);
						});
					} else { // 디테일 화면으로 이동  
						openInspDetail(inspNo);
					}
	            },
	            pagerContainerClass: "paginate",
	            deleteConfirm: function(item) {
	                return "\""+item.menuNm+"("+menuId+")"+"\""+ '[[#{screen.info.status.delete.yn}]]';
	            },
	            controller:  {
	                loadData: function(filter) {
	                    var d = $.Deferred();
	                    
	                    currentPage = filter.pageIndex; 
	                    let url = "/asset/insp/manage/selectInspManageList";
						let reqType = 'GET';	
						let data = {
            				"currentPage"  : filter.pageIndex,
            				"numOfRows"    : numOfRows,
            				"inspYear" 	   : $("#inspYear").val(),
            				"inspNm"  	   : $("#inspNm option:selected").val(),
            				"searchOption" : $("#searchOption option:selected").val(),
            				"sortField"    : filter.sortField,
            				"sortOrder"    : filter.sortOrder
            			}
						
						$.commRequest(url, reqType, data)
							.then((res) => {
								condition = res.condition;
								codeGrpMngList = res.data;
								$(".result").text("Results : " + res.condition.totalCount);
								d.resolve({data : res.data, itemsCount: res.condition.totalCount});
							})
							.catch((error) => {
								console.log('[[#{screen.info.status.error.search}]]');
							});						
	                    
	                    return d.promise();
	                },

           		},
	            fields: [
	            	{  	   name : "chk"
	                	 , align: "center"
	                	 , width: 5
	                	 , title: ""
	                	 , editing: false
	                	 , sorting: false
	                	 , filtering: false
	                	 , itemTemplate: function(value, item) {
	                       return $("<input>").attr("type", "checkbox").attr("class","singleCheckbox")
	                       .prop("checked", $.inArray(item.firstName, selectedItems) > -1)
	                       .on("change", function () {
	  					  	 //$(this).is(":checked") ? selectItem($(this).parent().next().text()) : unselectItem($(this).parent().next().text());
	  					  	 $(this).is(":checked") ? selectItem(item.inspNo) : unselectItem(item.inspNo);
	  					  	 });
	            		   }
	                	 , headerTemplate : function ()  { 
						  	 return  $("<input>").attr("type", "checkbox").attr("id","selectAllCheckbox")
		                     .on("change", function (item) {
		             	    	selectedItems = [];
		            	    	if(this.checked) { 
		            	            $('.singleCheckbox').each(function() { 
		            	                this.checked = true;   
		            	                selectItem($(this).parent().next().text());           
		            	            });			         
		            	        }else {
		            	        	
		            	            $('.singleCheckbox').each(function() { 
		            	                this.checked = false;      
		            	                unselectItem(item);
		            	            });  
		            	            selectedItems = [];
		            	        }
		    				   });
					 	 } ,
	                },
	                { name:"inspNo"			, type:"text", align:"center", width:10, title:"[[#{screen.text.asset.inspNo}]]"},			//실사번호
	                { name:"inspYear"		, type:"text", align:"center", width:10, title:"[[#{screen.text.asset.inspYear}]]"},     	//실사연도
	                { name:"inspNm"			, type:"text", align:"center", width:30, title:"[[#{screen.text.asset.inspNm}]]"},   		//실사명
	                { name:"inspStDt"		, type:"text", align:"center", width:10, title:"[[#{screen.text.asset.inspStDt}]]"},     	//실사시작일
	                { name:"inspEndDt"		, type:"text", align:"center", width:10, title:"[[#{screen.text.asset.inspEndDt}]]"},   	//실사종료일
	                { name:"onlineInspBaseDt",type:"text", align:"center", width:15, title:"[[#{screen.text.asset.onlineInspBaseDt}]]"},//온라인실사기준일
	                { name:"regr"			, type:"text", align:"center", width:15, title:"[[#{screen.text.asset.inspRegr}]]"},     	//실사생성자
	                { name:"inspTarget"		, type:"text", align:"center", width:15, title:"[[#{screen.text.asset.inspTarget}]]"},   	//실사대상자 산수
	                { name:"inspDeptPogress", type:"text", align:"center", width:15, title:"[[#{screen.text.asset.inspDeptPogress}]]"},	//부서별 진행상황
	                { name:"inspStusNm"		, type:"text", align:"center", width:10, title:"[[#{screen.text.asset.inspStus}]]"} 		//실사상태
	            ]
	        });          	
		});
		
		
		function getCommCode(id, code, level, upperCodeId){				
			let url = "/common/comm/selectBox";
			let reqType = 'GET';
			$.commRequestSelectbox(url, reqType, id, code, level, upperCodeId);			
		}
		
		// 실사명 코드리스트
		function getInspNmList(){
			let url = "/asset/insp/manage/selectInspNmList";
			
  			let reqType = 'GET';
  			let data={"currentPage"  : 0,
    				  "numOfRows"    : 999}
  			$.commRequest(url, reqType, data)
  				.then((res) => {
  					// option에 실사명 리스트 추가 
  					var str ="";
  		            $.each(res.data, function(i){
  		               str += '<option value="' + res.data[i].inspNm + '">' + res.data[i].inspNm + '</option>';
  		            })
  		            $("#inspNm").append(str);
  		            
  		          	$("#jsGrid").jsGrid("loadData");
  				})
  				.catch((error) => {
  					console.log(error);
  				})
		}
		
	    function enterkey() {
	    	if (window.event.keyCode == 13) {
	    		$("#jsGrid").jsGrid("loadData");
	        }
	    }
	    

	 	// 실사 디테일 화면 이동 
	    function openInspDetail(inspNo){
	       	event.preventDefault();
	       	
	       	let saveParams = {
	       		"condition": condition,
	       		"menuId"   : "[[${menuId}]]" ,
	       		"menuNm"   : "[[${menuNm}]]",
	       		"menuDesc" : "[[${menuDesc}]]",
	       	}
	       	
	       	$.commSaveSearchParams(SCREEN_NM, saveParams);
	       	
            let url = "/asset/insp/manage/inspManageDetail";
			let menuId = "[[${menuId}]]";
            
			var $form = $('<form></form>'); 
				$form.attr('action', url); 
				$form.attr('method', 'Post'); 
				$form.attr('target', '_self'); 
				
			var inspNoStr = $('<input type="hidden" value="'+ inspNo +'" name="inspNo">');
				$form.append(inspNoStr);
 				menuIdStr = $('<input type="hidden" value="' + menuId + '" name="menuId">');
				$form.append(menuIdStr); 					
				$form.appendTo('body'); 					
				$form.submit();
	    }
		
		</script>
	</th:block>
        
        
	<div layout:fragment="content">
	
		<!-- contents_head -->
		<div class="bc">Home &gt; <span th:text="${menuDesc}"></span></div>
		<h3><span th:text="${menuNm}"></span></h3>
		<!-- //contents_head -->	


		<!-- search -->
		<div class="srch_wrap single">
			<table class="srch_table">
				<colgroup>
					<col width="10%"/>
					<col width="20%"/>
					<col width="10%"/>
					<col width="20%"/>
					<col width="10%"/>
					<col width=""/>
				</colgroup>
				<tr>
					<th>[[#{screen.text.asset.inspYear}]]</th>
					<td><input type="text" placeholder="YYYY" id="inspYear" onkeyup="enterkey()" style="width:100%;"></td>
					<th>[[#{screen.text.asset.inspNm}]]</th>
					<td>
						<select id="inspNm" style="width:100%;">
							<option value="">[[#{screen.text.comm.choice}]]</option>
						</select>
					</td>
					<th> </th>
					<td> </td>
				</tr>
			</table>
			<div class="button">
				<a href="#;" class="btn_reset">[[#{screen.btn.reset}]]</a>
				<a href="#;" class="btn_srch">[[#{screen.btn.search}]]</a>										
			</div>
		</div>
		<!-- search -->
		
		<!-- //search -->
		<div class="list_head">
				<div class="result">Results : 0,000</div>
				<!-- list_button -->
				<div class="button">
					<a class="btn_add">[[#{screen.text.asset.inspAdd}]]</a> 
					<a class="btn_del">[[#{screen.btn.delete}]]</a>
				</div>
				<!-- list_button -->
		</div>
		<!-- list -->
		<!-- //search -->
		
		<!-- list -->
		<div id="jsGrid"></div>
		<input type="hidden" id="curr_Idx"/>
		<!-- //list -->
		
		<!-- insp create popup -->
		<!-- insp create popup -->
		
	</div>
        
</html>