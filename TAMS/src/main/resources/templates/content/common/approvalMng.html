<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="layout/default">

	<head>
	    <title>결재함 관리</title>
	</head>
        
	<!-- css -->
	<th:block layout:fragment="css">
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/jsgrid.css" />
		<link rel="stylesheet" href="/css/theme.css" />
		
	</th:block>
	
	<th:block layout:fragment="script">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
		<script src="/js/jsgrid/db.js"></script>
	    <script src="/js/jsgrid/jsgrid.core.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-indicator.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.sort-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.field.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.text.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.number.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.select.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.checkbox.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.control.js"></script>	
		
	    <script>
	    
	    var approvalItems = [];
	    
	    var approvalField = [
			{ name: "rownum"	, type: "number" , width:  30 ,align: "right" , title: "No."
			 ,itemTemplate: function(value, item) {
				 //console.log("###");
              return $("<span>").attr("id","row_"+item.appvId).text( getIndex(item)   );
			 }
			},
			{ name: "appvId"		, type: "text"   , width: 50 ,align: "center", title: "결재 ID"	},
			//{ name: "appvUserId"	, type: "text"   , width: 50 ,align: "center"  , title: "상신자ID"	},
			{ name: "appvUserNm"	, type: "text"   , width: 50 ,align: "center"  , title: "상신자ID"	},
			//{ name: "appvType"		, type: "text"   , width: 50 ,align: "center", title: "결재문서유형" 	},
			{ name: "appvTypeNm"		, type: "text"   , width: 50 ,align: "center", title: "결재문서유형" 	},
			{ name: "appvTtl"		, type: "text"   , width: 250 ,align: "left"  , title: "결재 제목"	 	},
			//{ name: "appvCn"		, type: "text"   , width: 100 ,align: "left"  , title: "본문"	 	},
			//{ name: "appvStus"		, type: "text" 	 , width: 50 ,align: "center" , title: "결재상태"	 	},
			{ name: "appvStusNm"		, type: "text" 	 , width: 50 ,align: "center" , title: "결재상태"	 	},
			//{ name: "appvStep"		, type: "text"   , width: 50 ,align: "center", title: "결재진행단계"	},
			{ name: "appvStepNm"		, type: "text"   , width: 50 ,align: "center", title: "결재진행단계"	},
		];
	    
	    function getIndex(item) {
			var idx= -1;
			$.each(approvalItems, function(index, el){
				if( item.appvId == el.appvId) idx = index; 
			});
			//console.log(item.poNo+" >> idx : "+idx);
			return idx+1;
		}
	
		function getGridBody() {
			return {
		        	height: "580",
		            width: "100%",
		            data: approvalItems, 
		            autoload: false,
		            loadonce: false,
		            updateOnResize: true, 
		            rowClick:function(args){
		            	openApprovalPopup(args.item.appvId);
						//console.log(args.item.appvId);
		            },
		            fields: approvalField
		            ,onDataLoaded: rowCount()
		    	};
		}
		
		function rowCount() {    
		    var count = approvalItems.length; console.log(count);
		    $(".result").html("Results : "+count);
		}
		
		
		function getAppvList() {
			
			let url = "/approval/approvalList";
			let reqType = "POST";	
			let data = {
				searchId : '',
				searchText: ''
			}
			
			$.commRequestFile(url, reqType, data)
				.then((res) => {
					console.log('결재목록 조회 성공!!');
					console.log(res);
					
					showGridData(res.data, "#jsGrid");
				})
				.catch((error) => {
					console.log('결재목록 조회 실패!!');
				});
			
		}
		
		function showGridData(arr, objNm) {
			approvalItems = arr;
			$(objNm).jsGrid(getGridBody());	
		}
		
		
		//결재상신 팝업 호출 
	    function openApprovalPopup(appvId) { 
	        // 팝업 호출 url
	        var url = "/approval/approvalPopup";
	        var popId = "approvalPopup";
	        var args = {};
	        args.width = 1100;
	        args.height = 800;
	        args.fullscreen = "no";
	        args.resizable = "no";
	        
	        var param = {};
	        param.id = 'appv_id';
	        param.value = appvId;	//자산번호
	        
	        openPopup(popId, url, args, param);
	    }
		
		$(function(){
			
			//////////////////////////////////////////////////////////////////
			$("#jsGrid").jsGrid(getGridBody());				
			//////////////////////////////////////////////////////////////////
			
			getAppvList();
		});
	    </script>	
	</th:block>

	<div layout:fragment="content">
		<!-- contents_head -->
		<div class="bc">Home &gt; <span th:text="${menuDesc}"></span></div>
		<h3><span th:text="${menuNm}"></span></h3>
		<!-- //contents_head -->

		<!-- search -->
		<div class="srch_wrap single">
			<table class="srch_table">
			<colgroup>
					<col width="10%"/>
					<col width="20%"/>
					<col width="15%"/>
					<col width="20%"/>
					<col width="15%"/>
			</colgroup>
				<tr>
					<td>
						<select id="searchOption" style="width:90%;">
							<option selected value="">검색항목 선택</option>
							<option value="appv_id">결재 ID</option>
							<option value="appv_ttl">제목</option>
						</select>
					</td>	
					<td>
						<input id="searchText" type="text" onkeyup="enterkey()" style="width:90%; margin:10px;">
					</td>
					<td class="search" colspan="3">
					<!-- [button search] -->
					<header th:replace="layout/fragments/button_srch :: buttonSrchFragment"></header>
					</td>
				</tr>
			</table>
		</div>
		<!-- //search -->
		<div class="list_head">
				<div class="result">Results : 0,000</div>
				<!-- [button cud ] -->
				<!-- <header th:replace="layout/fragments/button_cud :: buttonCudFragment"></header> -->
		</div>
		<!-- list -->
		<!-- //search -->

		<!-- list -->
		<div id="jsGrid"></div>
		<input type="hidden" id="curr_Idx"/>
		<!-- //list -->
	
	</div>
	
</html>