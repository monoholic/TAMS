<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="layout/default">

	<head>
	    <title>게시판 관리</title>
	</head>
        
	<!-- css -->
	<th:block layout:fragment="css">
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="/css/jsgrid.css" />
		<link rel="stylesheet" href="/css/theme.css" />
		
	</th:block>
	
	<th:block layout:fragment="script">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
		<script src="/js/jsgrid/db.js"></script>
	    <script src="/js/jsgrid/jsgrid.core.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-indicator.js"></script>
	    <script src="/js/jsgrid/jsgrid.load-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.sort-strategies.js"></script>
	    <script src="/js/jsgrid/jsgrid.field.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.text.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.number.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.select.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.checkbox.js"></script>
	    <script src="/js/jsgrid/fields/jsgrid.field.control.js"></script>	
		
	    <script>
	    let numOfRows = 10;
	    var status = true;
        var selectedItems = [];
	 	var insertedItems = [];
	 	var updatedItems = [];
	    
	 	$(document).ready(function(){                                                                    
		 	let url = '/system/bbs/bbsMng/codeList';                                                      
		 	let reqType = 'POST';                                                                        
		 	let data = {                                                                                 
		 		"email" : ""                                                                             
		 	};                                                                                           
		 	$.commRequest(url, reqType, JSON.stringify(data))                                            
		 		.then((res) => {                                                                         
		 			$.each(res.data, function(i){                                                        
		 				var codeGrpList = res.data[i];                                                  
		 				$("#bbsGrpId").append('<option value="">' + codeGrpList.codeNm+ '</option>');
		 			})
		 		})
		 		.catch((error) => {                                                                      
		 			alert('메뉴조회 실패!!');                                                                  
		 		});
		 });
	 	
	    $(function(){
	    	
	        $("#jsGrid").jsGrid({
	        	height: "400",
                width: "100%",
                filtering: false,
                editing: true,
                inserting: true,
                sorting: true,
                paging: true,
                sorter: "number",
                pageIndex:1,
                pageFirstText:'<a class="first"><img src="/images/common/btn_pn_first.gif"></img></a>',
                pagePrevText: '<a class="pre"><img src="/images/common/btn_pn_pre.gif"></img></a>',
                pageNextText: '<a class="next"><img src="/images/common/btn_pn_next.gif"></img></a>',
                pageLastText: '<a class="last"><img src="/images/common/btn_pn_last.gif"></img></a>',
                pagerFormat: "{first} {prev} {pages} {next} {last}",
                pagerContainer:null,
                pageLoading: true,
                pager: "#pager",
                autoload: status,
                pageSize: numOfRows,
                pageButtonCount: 5,
                loadonce: true,
                updateOnResize: true, 
	            rowClick: function(args) {
	            	var target = args.event.target;
	            	
					if(target instanceof HTMLTableCellElement) {
						// detail form
						showDetailForm(args.item);
					} else {
					   	$("<input>").attr("type", "checkbox").attr("class","singleCheckbox")
					                .prop("checked", $.inArray(args.item.firstName, selectedItems) > -1)
					                .on("change", function () {
						  	 $(this).is(":checked") ? selectItem($(this).parent().next().text()) : unselectItem($(this).parent().next().text());
						});
					}
	            }, 
	            pagerContainerClass: "paginate",
	            deleteConfirm: function(item) {
	                return "\""+item.menuNm+"("+menuId+")"+"\""+ "을 삭제 하시겠습니까?";
	            },
	            controller:  {
	                loadData: function(filter) {
	                    var d = $.Deferred();
	                    
	                    currentPage = filter.pageIndex; 
               			
	                    let url = "";
						let reqType = 'GET';	
						let data = {
            				"currentPage"  : filter.pageIndex,
            				"numOfRows"    : numOfRows,
            				"searchText"   : $("#searchText").val(),
            				"searchOption" : $("#searchOption option:selected").val(),
            				"useYnOption"  : $("#delYnOption option:selected").val(),
            				"sortField"    : filter.sortField,
            				"sortOrder"    : filter.sortOrder
            			}
						$.commRequest(url, reqType, data)
							.then((res) => {
								$(".result").text("Results : " + res.condition.totalCount);
								d.resolve({data : res.data, itemsCount: res.condition.totalCount});

							})
							.catch((error) => {
								console.log('메뉴조회 실패!!');
							});						
	                    
	                    return d.promise();
	                },

	            updateItem: function(item) { 
            		
                	let url = "/system/bbs/bbsMng/bbsUpdate";
                	let reqType = 'GET';
                	$.commRequest(url, reqType, item)
                		.then((res) => {
                			console.log(res);
                			
                			alert("수정이 완료되었습니다.");
                			$("#jsGrid").jsGrid("loadData");
                		})
                		.catch((error) => {
                			console.log(error);
                		})
                },
             	
             	insertItem: function(item) { 
             		//insertedItems.push(item);
        			let url = "/system/bbs/bbsMng/bbsInsert";
        			let reqType = 'GET';
        			
        			$.commRequest(url, reqType, item)
        				.then((res) => {
        					console.log(res);
        				})
        				.catch((error) => {
        					console.log(error);
        				})
            		}
            	},
	        });
	        
		    var selectItem = function(item) {
		    	if(!selectedItems.includes(item))
			    selectedItems.push(item);
			    if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
	             $("#selectAllCheckbox").prop("checked", true);
	         } else {
	             $("#selectAllCheckbox").prop("checked", false);
	         }
			};
		     
		    var unselectItem = function(item) {
			    selectedItems = $.grep(selectedItems, function(i) {
			    return i !== item;
			    });
			    if(selectedItems.length == 0) {
			    	$('#selectAllCheckbox').attr('checked', false);
			    }
			    if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
	             $("#selectAllCheckbox").prop("checked", true);
	         } else {
	             $("#selectAllCheckbox").prop("checked", false);
	         }
		    };
	        
	        $("#pager").on("change", function() {
	            var page = parseInt($(this).val(), 10);
	            $("#jsGrid").find(".jsgrid-table").append("<tr class='jsgrid-row'></tr>");
	        });

	        
	        ////////////////////////////////////////////////////////////////////
    	    $(".btn_add").click(function() {
    	    	//$("#jsGrid").jsGrid("option", "inserting", "true");
    	    	showDetailForm();
    	    });
	        
    	    $(".btn_del").click(function() {
    	    	
    	    	var items = $("#bbs_Id").text();
    	    	
    	    	//별도 호출
    	    	let url = "/system/bbs/bbsMng/bbsDelete";
    			let reqType = 'GET';
    			dataType: 'json';
    			let data={
    				"items": items
    			}
    			
    			$.commRequest(url, reqType, data)
    				.then((res) => {
    					console.log(res);
    					$('.btn_srch').click();
    				})
    				.catch((error) => {
    					alert("오류가 발생했습니다");
    					console.log(error);
    				})
    			
    			alert("삭제 되었습니다!");
    			
    			var $form = $('<form id="form"></form>'); 
				$form.attr('action', "/system/bbs/bbsList"); 
				$form.attr('method', 'post'); 
				$form.appendTo('body');
				
				$form.submit();
    	    });
	        
	     	// 팝업창 저장 버튼 처리
            $('.save_btn').on('click', function (e) {
                e.preventDefault();
                
                var insert_item = {};    
                	insert_item.bbsId    = $(".detail_table").find("#bbsId").val();
		    		insert_item.bbsGrpId = $("#bbsGrpId option:selected").text();
		    		insert_item.bbsDp    = $(".detail_table").find("#bbsDp").val();
		    		insert_item.bbsTtl   = $(".detail_table").find("#bbsTtl").val();
		    		insert_item.bbsCn    = $("textarea[id=bbsCn]").val();
		    		insert_item.delYn    = $(".detail_table").find("#delYn").val();
		    	
		        var action = "";
		        
		        // alert(JSON.stringify(insert_item));
		        
		    	if(save_mode == "insert") {
		    		action = "insertItem";
		    		//insertedItems.push(insert_item); --일괄
		    	}else if(save_mode == "update") {
		    		action = "updateItem";
		    		//updatedItems.push(insert_item); --일괄
		    	}
		    	
    			$("#jsGrid").jsGrid(action, insert_item);
	    		
    			clearDetailForm();
	    		
                $(this).parents("#detailForm").hide();
                save_mode = "";
                
                var $form = $('<form id="form"></form>'); 
				$form.attr('action', "/system/bbs/bbsList"); 
				$form.attr('method', 'post'); 
				$form.appendTo('body');
				
				$form.submit();
            });
	     	
    	  	// 수정 버튼
    	    $(".btn_update").click(function() {
    	    	
    	    	var insert_item = {};
    	    	insert_item.bbsId  = $("#bbs_Id").text();
    	    	insert_item.bbsGrpId = $("#bbs_GrpId").text();
    	    	insert_item.bbsDp = $("#bbs_Dp").text();
            	insert_item.bbsTtl = $("#bbs_Ttl").text();
            	insert_item.bbsCn = $("#bbs_Cn").text();
            	insert_item.delYn = $("#del_Yn").text();
            	
    	    	showDetailForm(insert_item);
    	    });
          	
          	// 리셋 버튼
    	    $(".btn_reset").click(function() {
    	    	$("#searchText").val("");
    	    	$("#searchOption option:eq(0)").prop("selected",true);
    	    	$("#delYnOption option:eq(0)").prop("selected",true);
    	    });
          	
          	// 목록 버튼
	     	$(".btn_back").click(function() {
	     		
	     		var $form = $('<form id="form"></form>'); 
				$form.attr('action', "/system/bbs/bbsList"); 
				$form.attr('method', 'post'); 
				$form.appendTo('body');
				
				$form.submit();
	     	});
          	
	     	// 팝업창 닫기 버튼 처리
            $('.close_btn').on('click', function (e) {
                e.preventDefault();
                clearDetailForm();
                $(this).parents("#detailForm").hide();
                selectedItems = [];
            });
	     	
            //drag 활성화
	     	$("#detailForm").draggable();
            
            //팝업 가운데로 띄우기
            jQuery.fn.center = function () {
                this.css("position","absolute");
                this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) + $(window).scrollTop()) + "px");
                this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) + $(window).scrollLeft()) + "px");
                return this;
            }
	    	    
    	});
	    
	    function clearDetailForm() {
	    	$(".detail_table").find("#bbsId").val("");
	    	$(".detail_table").find("#bbsTtl").val("");
	    	$("textarea[id=bbsCn]").val("");
   		    $(".detail_table").find("#bbsDp").val("");
   		 	$("#bbsGrpId option:eq(0)").prop("selected",true);
   		 	$("#delYn option:eq(0)").prop("selected",true);
	    }
	    
	    let save_mode = "";
	    function showDetailForm(item) {
	    	if(selectedItems.length <= 1){
		    	
		    	let title = "게시글 등록";
		    	 var readOnly = false;
		    	 
		    	 if( item != null ) {
		    		 title = "게시글 수정";
		    		 save_mode = "update";
		    		 
		    		 readOnly = false;
		    		 
		    		 $(".detail_table").find("#bbsId").val(item.bbsId);
		    		 $("#bbsGrpId option:contains("+item.bbsGrpId+")").prop("selected", true);
		    		 $(".detail_table").find("#bbsDp").val(item.bbsDp);
		    		 $(".detail_table").find("#bbsTtl").val(item.bbsTtl);
		    		 $("textarea[id=bbsCn]").val(item.bbsCn);
		    		 $(".detail_table").find("#delYn").val(item.delYn);

		    	 } else {
		    		 save_mode = "insert";
		    	 }
		    		
		    	 $(".list_head").find("#head_title").html(title);
		    	
		    	 //상세 팝업 호출
		    	 $('#detailForm').css({
	                 position: 'absolute',
	                 top	 : "10px",
	                 left	 : "10px",
	                 width	 : "650px",
	                 height	 : "700px"
	             }).center().show();
	    	}else{
	    		alert("수정은 1개이상 되지 않습니다.");
	    	}
	    }
	    
	    function enterkey() {
	    	if (window.event.keyCode == 13) {
	    		$("#jsGrid").jsGrid().trigger("loadData");
	        }
	    }
	    </script>	
	</th:block>

	<div layout:fragment="content">
		<!-- contents_head -->
		<div class="bc">Home &gt; 공지사항
		</div>
		<h3>공지사항</h3>
		<!-- //contents_head -->
		
		<div class="list_head">
				<!-- list_button -->
				<div class="button">
					<!-- 				
					<a class="btn_add">메뉴 등록</a>
					<a class="btn_saveall">일괄 저장</a>
					<a class="btn_del">메뉴 삭제</a>
					-->
					<a class="btn_update">수정</a>
					<a class="btn_del">삭제</a>
					<a class="btn_back">목록</a>
				</div>
		</div>
		
		<div class="view_wrap">
			<span id="bbs_Id" th:text="${bbsId}" style="display:none;"></span>
			<span id="bbs_GrpId" th:text="${bbsGrpId}" style="display:none;"></span>
			<span id="bbs_Dp" th:text="${bbsDp}" style="display:none;"></span>
			
			<span id="del_Yn" th:text="${delYn}" style="display:none;"></span>
			<h4><span id="bbs_Ttl" th:text="${bbsTtl}"></span></h4>
			<div class="view_write"><span id="user_Id" th:text="${userId}"></span></div>
			<dl class="view_info">
				<dt>등록일 :</dt><dd><span id="reg_Dt" th:text="${regDt}"></span></dd>
				<dt>조회수:</dt><dd><span id="view_Cnt" th:text="${viewCnt}"></span></dd>
			</dl>
			<div class="view_article"><span id="bbs_Cn" th:text="${bbsCn}"></span></div>
		</div>
		
		<!-- 첨부파일 attach_file -->
		<h4>첨부파일 <span class="focus">(10MB까지 첨부 가능합니다)</span></h4>
		<div class="attach_check">
			<label><input type="checkbox" value=""></label>
				<a class="btn_list_sm_rd">파일찾기</a>
				<a class="btn_list_sm">아래</a>
				<a class="btn_list_sm">위</a>
				<a class="btn_list_sm">삭제</a>
			<div class="file_size">(712.79KB/10MB)</div><!-- 전체용량 적용 가능시 -->
		</div>
		<div class="attach_file">
			<ul>
				<li><label><input type="checkbox" value=""><a href="#"><img src="../images/common/ico_f_ppt.gif">첨부파일이름.ppt</a></label>
					<div class="file_size">1,301.5KB</div>
				</li>
				<li><label><input type="checkbox" value=""><a href="#"><img src="../images/common/ico_f_xls.gif">첨부파일이름.xls</a></label>
					<div class="file_size">901.5KB</div>
				</li>
				<li><label><input type="checkbox" value=""><a href="#"><img src="../images/common/ico_f_doc.gif">첨부파일이름.doc</a></label>
					<div class="file_size">5301.15KB</div>
				</li>
			</ul>
		</div>
		
		<!-- detail popup -->
		<div id="detailForm" class="list_head" style="display:none;">
	  		<div id="container">
		        <!-- list_head -->
				<div class="list_head">
					<h6><span id="head_title" ></span></h6>
					<!-- list_button -->
					<div class="button">
						<a class="btn_list save_btn">저장</a>
						<a class="btn_list close_btn">닫기</a>
					</div>
					<!-- list_button -->
				</div>
				<!-- //list_head -->
				
				
				<!-- detail_table -->
				<table class="detail_table form_s">
					<colgroup>
						<col style="width:10%"/>
						<col style="width:22%"/>
						<col style="width:10%"/>
						<col style="width:15%"/>
						<col style="width:10%"/>
						<col style="width:15%"/>
					</colgroup>
					 					
					<tr>
						<th style="text-align:center;">제목</th>
						<td colspan="5">
							<input id="bbsId" type="hidden">
							<input id="bbsTtl" style="width:100%" type="text" >
						</td>
					</tr>
					
					<tr>
						<th style="text-align:center;">게시글<br>그룹</th>
						<!-- <td><input id="bbsGrpId" style="width:100%;" type="text"></td> -->
						<td>
							<select id="bbsGrpId" style="width:100%">
								<option selected value="">검색항목 선택</option>
							</select>
						</td>
						
						<th style="text-align:center;">게시글<br>레벨</th>
						<td><input id="bbsDp" type="number" style="width:97%"></td>
						
						<th style="text-align:center;">삭제 구분</th>
						<td>
							<select id="delYn" style="width:100%">
								<option selected value="">삭제 구분</option>
								<option value="Y">삭제</option>
								<option value="N">미삭제</option>
							</select>
						</td>	
					</tr>
					
				</table>
				<!-- //detail_table -->

				<!-- Edit Area-->
				<textarea id="bbsCn" style="width: 100%; height: 300px; resize:none;"></textarea>
				<!-- //Edit Area-->
				
				<!-- 첨부파일 attach_file -->
				<h4>첨부파일 <span class="focus">(10MB까지 첨부 가능합니다)</span></h4>
				<div class="attach_check">
					<label><input type="checkbox" value=""></label>
						<a class="btn_list_sm_rd">파일찾기</a>
						<a class="btn_list_sm">아래</a>
						<a class="btn_list_sm">위</a>
						<a class="btn_list_sm">삭제</a>
					<div class="file_size">(712.79KB/10MB)</div><!-- 전체용량 적용 가능시 -->
				</div>
				<div class="attach_file">
					<ul>
						<li><label><input type="checkbox" value=""><a href="#"><img src="../images/common/ico_f_ppt.gif">첨부파일이름.ppt</a></label>
							<div class="file_size">1,301.5KB</div>
						</li>
						<li><label><input type="checkbox" value=""><a href="#"><img src="../images/common/ico_f_xls.gif">첨부파일이름.xls</a></label>
							<div class="file_size">901.5KB</div>
						</li>
						<li><label><input type="checkbox" value=""><a href="#"><img src="../images/common/ico_f_doc.gif">첨부파일이름.doc</a></label>
							<div class="file_size">5301.15KB</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!-- detail popup -->
		<div id="jsGrid" style="display:none;"></div>
	</div>
</html>